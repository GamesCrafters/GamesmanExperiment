#!/bin/bash
# This script was modified from its original version generated by ChatGPT.
# Always run this script from the root project directory.

# Function to print an error and exit
error_exit() {
    echo "Error: $1" 1>&2
    echo "Please ensure all dependencies are installed and try again."
    exit 1
}

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to install dependencies on Debian/Ubuntu
install_debian() {
    apt update && apt install -y git autoconf automake cmake zlib1g zlib1g-dev
}

# Function to install dependencies on RHEL/CentOS
install_rhel() {
    dnf update && dnf install -y git autoconf automake cmake zlib zlib-devel
}

# Function to install dependencies on MacOS
install_macos() {
    # Assuming Homebrew is installed
    xcode-select --install
    brew install git autoconf automake cmake zlib
}

# Detect OS and architecture
OS="$(uname -s)"
ARCH="$(uname -m)"

# Check if running as root
if [ "$(id -u)" -ne 0 ]; then
    case "$OS" in
    Linux*)
        echo "Not running as root. Will skip steps that require root access."
        INSTALL_DEPENDENCIES=false
        ;;
    Darwin*)
        INSTALL_DEPENDENCIES=true
        ;;
    *)
        error_exit "Unsupported operating system."
        ;;
    esac
else
    INSTALL_DEPENDENCIES=true
fi

# Install dependencies based on OS only if has root access.
if [ "$INSTALL_DEPENDENCIES" = true ]; then
    case "$OS" in
    Linux*)
        # Detect if using Debian/Ubuntu or RHEL/CentOS
        if [ -f /etc/debian_version ]; then
            install_debian || error_exit "Failed to install dependencies on Debian/Ubuntu."
        elif [ -f /etc/redhat-release ]; then
            install_rhel || error_exit "Failed to install dependencies on RHEL/CentOS."
        else
            error_exit "Unsupported Linux distribution."
        fi
        ;;
    Darwin*)
        install_macos || error_exit "Failed to install dependencies on MacOS."
        ;;
    *)
        error_exit "Unsupported operating system."
        ;;
    esac
else
    echo "Skipping installation of dependencies due to lack of root privileges."
fi

# Check for required commands
for cmd in git autoconf automake autoreconf cmake; do
    command_exists "$cmd" || error_exit "command $cmd not found."
done

# Begin project setup
git submodule update --init || error_exit "Failed to update git submodules."

cd lib/json-c/ || error_exit "Failed to change directory to lib/json-c."
mkdir build
cd build || error_exit "Failed to create or change to the build directory."

CMAKE_FLAGS="-DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=../../../res -DCMAKE_OSX_ARCHITECTURES=x86_64;arm64"
cmake $CMAKE_FLAGS ../ || error_exit "Failed to configure json-c using cmake."
make -j || error_exit "json-c make failed."
make install -j || error_exit "json-c make install failed."
cd ../../../ || error_exit "Failed to change directory back to project root."

autoreconf --install || error_exit "autoreconf --install failed."
./configure 'CFLAGS=-Wall -Wextra -g -O3 -DNDEBUG' || error_exit "configure script failed."
make -j || error_exit "GamesmanOne make failed."
